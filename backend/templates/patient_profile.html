{% extends "layout.html" %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">

	<!-- Header Section -->
	<div
		class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
		<div class="flex items-center gap-4">
			<div
				class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center text-teal-600 text-2xl font-bold">
				{{ patient.name[0] }}
			</div>
			<div>
				<h1 class="text-2xl font-bold text-slate-800">{{ patient.name }}</h1>
				<div class="flex items-center gap-3 text-sm text-slate-500 mt-1">
					<span class="bg-slate-100 px-2 py-0.5 rounded text-xs font-semibold tracking-wide">ID: {{
						(patient._id|string)[-6:] }}</span>
					<span>{{ patient.age }} Years</span>
					<span class="w-1 h-1 bg-slate-300 rounded-full"></span>
					<span>{{ patient.gender }}</span>
				</div>
			</div>
		</div>
		<div class="flex gap-3">
			<a href="{{ url_for('patient_list') }}"
				class="px-4 py-2 text-slate-600 hover:text-slate-800 hover:bg-slate-50 rounded-lg transition-colors text-sm font-medium">
				&larr; Back to Dashboard
			</a>
			<button onclick="openEditModal()"
				class="bg-teal-600 hover:bg-teal-700 text-white px-5 py-2 rounded-lg shadow-sm transition-all text-sm font-medium flex items-center gap-2">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
					stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
						d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
				</svg>
				Edit Profile
			</button>
		</div>
	</div>

	<!-- Tabs Navigation -->
	<div class="border-b border-slate-200">
		<nav class="flex space-x-8" aria-label="Tabs">
			<button onclick="switchTab('personal')" id="tab-personal"
				class="tab-btn border-b-2 border-teal-500 text-teal-600 py-4 px-1 text-sm font-medium transition-colors">
				Personal
			</button>
			<button onclick="switchTab('consultation')" id="tab-consultation"
				class="tab-btn border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 text-sm font-medium transition-colors">
				Consultation
			</button>
			<button onclick="switchTab('documents')" id="tab-documents"
				class="tab-btn border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 text-sm font-medium transition-colors">
				Documents
			</button>
			<button onclick="switchTab('reports')" id="tab-reports"
				class="tab-btn border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 py-4 px-1 text-sm font-medium transition-colors">
				Reports
			</button>
		</nav>
	</div>

	<!-- Tab Content: Personal -->
	<div id="content-personal" class="tab-content block animate-fade-in-up">
		<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
			<h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-500" fill="none" viewBox="0 0 24 24"
					stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
						d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
				</svg>
				Patient Demographics
			</h3>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-8 gap-x-12">
				<div>
					<span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Full
						Name</span>
					<span class="text-slate-700 font-medium">{{ patient.name }}</span>
				</div>
				<div>
					<span
						class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Contact</span>
					<span class="text-slate-700 font-medium">{{ patient.contact }}</span>
				</div>
				<div>
					<span
						class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Address</span>
					<span class="text-slate-700 font-medium">{{ patient.address }}</span>
				</div>
				<div>
					<span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Height</span>
					<span class="text-slate-700 font-medium">{{ patient.get('height', '--') }} cm</span>
				</div>
				<div>
					<span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Weight</span>
					<span class="text-slate-700 font-medium">{{ patient.get('weight', '--') }} kg</span>
				</div>
				<div>
					<span class="block text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Sleeping
						Hours</span>
					<span class="text-slate-700 font-medium">{{ patient.get('sleeping_hours', '--') }} hrs/night</span>
				</div>
			</div>

			<div class="border-t border-slate-100 my-8"></div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
				<div>
					<h4 class="font-medium text-slate-800 mb-3">Past Medical History</h4>
					<p
						class="text-slate-600 text-sm leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-100">
						{{ patient.get('medical_history') or 'No medical history recorded.' }}
					</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Tab Content: Consultation -->
	<div id="content-consultation" class="tab-content hidden">
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-300px)] min-h-[500px]">
			<!-- Left: AI Scribe -->
			<div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col relative overflow-hidden">
				<div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
					<h3 class="font-bold text-slate-700 flex items-center gap-2">
						<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
						AI Scribe
					</h3>
					<span class="text-xs text-slate-400">Ready to listen</span>
				</div>

				<form action="{{ url_for('add_consultation', pid=patient._id) }}" method="POST" id="consultForm"
					class="flex-1 flex flex-col p-4">
					<textarea name="notes" id="transcriptionText"
						class="flex-1 w-full bg-transparent border-0 focus:ring-0 p-2 text-slate-700 text-lg leading-relaxed placeholder-slate-300 resize-none font-mono"
						placeholder="Start speaking or type your clinical notes here..."></textarea>

					<div class="flex flex-wrap justify-between items-center mt-4 gap-2">
						<div class="flex items-center gap-2">
							<!-- Audio Upload -->
							<label
								class="cursor-pointer text-slate-500 hover:text-slate-700 p-2 rounded hover:bg-slate-100"
								title="Upload Audio">
								<input type="file" id="audioUpload" accept="audio/*" class="hidden"
									onchange="uploadAudio(this)">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
									stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
								</svg>
							</label>

							<button type="button" onclick="printSection()"
								class="text-slate-500 hover:text-slate-700 p-2 rounded hover:bg-slate-100"
								title="Print">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
									stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
								</svg>
							</button>
							<button type="button" onclick="copyToClipboard()"
								class="text-slate-500 hover:text-slate-700 p-2 rounded hover:bg-slate-100" title="Copy">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
									stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
								</svg>
							</button>
							<div class="relative group">
								<button type="button"
									class="text-slate-500 hover:text-slate-700 p-2 rounded hover:bg-slate-100 flex items-center gap-1"
									title="Share">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
										viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
									</svg>
								</button>
								<div
									class="absolute left-0 bottom-full mb-2 w-32 bg-white rounded-lg shadow-lg border border-slate-100 hidden group-hover:block z-20">
									<a href="#" onclick="shareVia('mail'); return false;"
										class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">Email</a>
									<a href="#" onclick="shareVia('whatsapp'); return false;"
										class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50">WhatsApp</a>
								</div>
							</div>
						</div>

						<div class="flex items-center gap-4">
							<div id="status" class="text-xs text-slate-400 italic"></div>
							<button type="submit"
								class="bg-slate-900 text-white px-6 py-2 rounded-lg hover:bg-slate-800 transition-colors text-sm font-medium">
								Save to Timeline
							</button>
						</div>
					</div>
				</form>

				<!-- Floating Mic Button -->
				<button id="recordBtn"
					class="absolute bottom-24 right-8 w-14 h-14 bg-teal-500 hover:bg-teal-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-105 active:scale-95 z-10 group">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:animate-bounce" fill="none"
						viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
					</svg>
				</button>
			</div>

			<!-- Right: Timeline -->
			<div class="bg-slate-50 rounded-xl border border-slate-200 overflow-y-auto p-6 scrollbar-thin">
				<h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-6">Patient Timeline</h3>

				<div class="space-y-8 pl-2">
					{% if patient.consultations %}
					{% for item in patient.consultations|reverse %}
					<div class="relative pl-8 border-l-2 border-slate-200 pb-2 last:border-0 group">
						<div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-white border-2 border-teal-500">
						</div>
						<div class="flex justify-between items-start mb-2">
							<div class="flex flex-col">
								<span class="text-sm font-bold text-slate-800">{{ item.date[:10] }}</span>
								<span class="text-xs text-slate-500">{{ item.date|format_time }}</span>
							</div>
							<div class="flex items-center gap-2">
								<span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">{{
									item.type|default('Clinical Note') }}</span>
								{% if item.id %}
								<button type="button"
									data-url="{{ url_for('delete_consultation', pid=patient._id, cid=item.id) }}"
									onclick="openDeleteModal(this.dataset.url)"
									class="text-slate-400 hover:text-red-500 p-1 transition-opacity" title="Delete">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
										viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
									</svg>
								</button>
								{% endif %}
							</div>
						</div>
						<div
							class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-sm text-slate-600 leading-relaxed">
							{{ item.text }}
						</div>
						<div class="mt-1 text-xs text-slate-400">Recorded by {{ item.doctor or 'System' }}</div>
					</div>
					{% endfor %}
					{% else %}
					<div class="text-center py-10 text-slate-400">
						<p>No consultations recorded yet.</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Tab Content: Documents -->
	<div id="content-documents" class="tab-content hidden">
		<div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
			<div class="sm:flex sm:items-center sm:justify-between mb-8">
				<div>
					<h3 class="text-lg font-bold text-slate-800">Medical Documents</h3>
					<p class="text-sm text-slate-500">X-Rays, Lab Results, and Prescriptions</p>
				</div>
			</div>

			<!-- Upload Zone -->
			<form action="{{ url_for('upload_file_route', pid=patient._id) }}" method="POST"
				enctype="multipart/form-data"
				class="border-2 border-dashed border-slate-300 rounded-xl p-8 hover:bg-slate-50 transition-colors text-center cursor-pointer relative mb-10 group">
				<input type="file" name="file" onchange="this.form.submit()"
					class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
				<div class="space-y-2">
					<svg xmlns="http://www.w3.org/2000/svg"
						class="mx-auto h-12 w-12 text-slate-300 group-hover:text-teal-500 transition-colors" fill="none"
						viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
							d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
					</svg>
					<p class="text-sm font-medium text-slate-700">Click to upload or drag and drop</p>
					<p class="text-xs text-slate-400">SVG, PNG, JPG or PDF</p>
				</div>
			</form>

			<!-- Gallery -->
			<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
				{% if patient.files %}
				{% for file in patient.files %}
				<a href="{{ file.url }}" target="_blank"
					class="group relative block aspect-square bg-slate-100 rounded-lg overflow-hidden border border-slate-200 hover:shadow-md transition-all">
					{% if file.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
					<img src="{{ file.url }}" alt="{{ file.original_name }}"
						class="w-full h-full object-cover group-hover:opacity-90 transition-opacity">
					{% else %}
					<div class="w-full h-full flex items-center justify-center text-slate-400">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24"
							stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
						</svg>
					</div>
					{% endif %}
					<div
						class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
						<p class="text-white text-xs truncate font-medium">{{ file.original_name }}</p>
					</div>
				</a>
				{% endfor %}
				{% else %}
				<div class="col-span-full text-center py-4 text-slate-400 italic">No documents uploaded yet.</div>
				{% endif %}
			</div>
		</div>
	</div>

	<!-- Tab Content: Reports -->
	<div id="content-reports" class="tab-content hidden">
		<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
			<div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
				<div>
					<h3 class="text-lg font-bold text-slate-800">Generated Reports</h3>
					<p class="text-sm text-slate-500">Automated summaries from consultations</p>
				</div>
				<button class="text-sm text-teal-600 font-medium hover:text-teal-700">Generate New Report</button>
			</div>

			<div class="divide-y divide-slate-100">
				<!-- Placeholder items -->
				<div class="p-6 hover:bg-slate-50 transition-colors flex items-center justify-between">
					<div class="flex items-center gap-4">
						<div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
								stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
							</svg>
						</div>
						<div>
							<h4 class="font-medium text-slate-800">Initial Assessment Summary</h4>
							<p class="text-xs text-slate-500">Generated on Feb 18, 2026</p>
						</div>
					</div>
					<button class="text-sm text-slate-400 hover:text-slate-600">Download PDF</button>
				</div>
				<div
					class="p-6 hover:bg-slate-50 transition-colors flex items-center justify-center text-slate-400 italic text-sm">
					No more reports available.
				</div>
			</div>
		</div>
	</div>

	<!-- Edit Patient Modal -->
	<div id="editPatientModal"
		class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center animate-fade-in backdrop-blur-sm">
		<div
			class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-0 overflow-hidden transform transition-all scale-100 m-4">
			<div class="bg-teal-600 p-6 flex justify-between items-center text-white">
				<h3 class="text-xl font-bold">Edit Patient Profile</h3>
				<button onclick="closeEditModal()" class="hover:bg-teal-700 p-2 rounded-full transition-colors">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
						stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</div>

			<form id="editPatientForm" class="p-8 max-h-[80vh] overflow-y-auto" autocomplete="off">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
					<!-- Name -->
					<div class="col-span-full">
						<label class="block text-sm font-semibold text-slate-700 mb-2">Full Name</label>
						<input type="text" name="name" value="{{ patient.name }}" required
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>

					<!-- Age & Gender -->
					<div>
						<label class="block text-sm font-semibold text-slate-700 mb-2">Age</label>
						<input type="number" name="age" value="{{ patient.age }}" required
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>
					<div>
						<label class="block text-sm font-semibold text-slate-700 mb-2">Gender</label>
						<select name="gender" required
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
							<option value="Male" {% if patient.gender=='Male' %}selected{% endif %}>Male</option>
							<option value="Female" {% if patient.gender=='Female' %}selected{% endif %}>Female</option>
							<option value="Other" {% if patient.gender=='Other' %}selected{% endif %}>Other</option>
						</select>
					</div>

					<!-- Contact -->
					<div class="col-span-full">
						<label class="block text-sm font-semibold text-slate-700 mb-2">Contact Number</label>
						<input type="tel" name="contact" value="{{ patient.contact }}" required
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>

					<!-- Address -->
					<div class="col-span-full">
						<label class="block text-sm font-semibold text-slate-700 mb-2">Address</label>
						<textarea name="address" rows="2"
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">{{ patient.get('address', '') }}</textarea>
					</div>

					<!-- Vitals -->
					<div>
						<label class="block text-sm font-semibold text-slate-700 mb-2">Height (cm)</label>
						<input type="text" name="height" value="{{ patient.get('height', '') }}"
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>
					<div>
						<label class="block text-sm font-semibold text-slate-700 mb-2">Weight (kg)</label>
						<input type="text" name="weight" value="{{ patient.get('weight', '') }}"
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>
					<div>
						<label class="block text-sm font-semibold text-slate-700 mb-2">Sleeping Hours</label>
						<input type="text" name="sleeping_hours" value="{{ patient.get('sleeping_hours', '') }}"
							class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-colors">
					</div>
				</div>

				<div class="mt-8 flex justify-end gap-3 pt-6 border-t border-slate-100">
					<button type="button" onclick="closeEditModal()"
						class="px-6 py-2.5 border border-slate-300 rounded-lg text-slate-700 font-medium hover:bg-slate-50 transition-colors">
						Cancel
					</button>
					<button type="submit" id="savePatientBtn"
						class="px-6 py-2.5 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-lg hover:shadow-teal-500/30 transition-all flex items-center justify-center min-w-[100px]">
						<span>Save Changes</span>
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Delete Confirmation Modal -->
	<div id="deleteModal"
		class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center animate-fade-in">
		<div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 transform transition-all scale-100">
			<div class="text-center">
				<div class="bg-red-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24"
						stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
					</svg>
				</div>
				<h3 class="text-lg font-bold text-slate-800 mb-2">Confirm Delete</h3>
				<p class="text-slate-500 text-sm mb-6">Are you sure you want to delete this consultation note? This
					action cannot be undone.</p>

				<form id="deleteForm" method="POST" class="flex gap-3 justify-center">
					<button type="button" onclick="closeDeleteModal()"
						class="px-5 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-700 text-sm font-medium hover:bg-slate-50 transition-colors">
						Cancel
					</button>
					<button type="submit"
						class="px-5 py-2.5 bg-red-600 rounded-lg text-white text-sm font-medium hover:bg-red-700 shadow-sm transition-colors">
						Yes, Delete
					</button>
				</form>
			</div>
		</div>
	</div>

</div>

<script>
	// Edit Patient Modal Logic
	function openEditModal() {
		const form = document.getElementById('editPatientForm');
		const btn = document.getElementById('savePatientBtn');

		// Reset form to server-provided values (HTML attributes)
		form.reset();

		// Ensure button is enabled and has correct text
		btn.disabled = false;
		btn.innerHTML = '<span>Save Changes</span>';

		document.getElementById('editPatientModal').classList.remove('hidden');
	}

	function closeEditModal() {
		document.getElementById('editPatientModal').classList.add('hidden');
	}

	document.getElementById('editPatientModal').addEventListener('click', function (e) {
		if (e.target === this) {
			closeEditModal();
		}
	});

	document.getElementById('editPatientForm').addEventListener('submit', async function (e) {
		e.preventDefault();
		const btn = document.getElementById('savePatientBtn');
		const originalText = btn.innerHTML;
		btn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
		btn.disabled = true;

		const formData = new FormData(this);
		const data = Object.fromEntries(formData.entries());

		// Convert numbers
		data.age = parseInt(data.age);

		try {
			const response = await fetch('/patients/{{ patient._id }}', {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(data)
			});

			if (response.ok) {
				window.location.reload();
			} else {
				alert('Failed to update profile. Please try again.');
				btn.innerHTML = originalText;
				btn.disabled = false;
			}
		} catch (error) {
			console.error('Error:', error);
			alert('An error occurred. Please check console.');
			btn.innerHTML = originalText;
			btn.disabled = false;
		}
	});

	// Modal Logic
	function openDeleteModal(url) {
		document.getElementById('deleteForm').action = url;
		document.getElementById('deleteModal').classList.remove('hidden');
	}

	function closeDeleteModal() {
		document.getElementById('deleteModal').classList.add('hidden');
	}

	// Tab Switching Logic
	function switchTab(tabName) {
		// Hide all content
		document.querySelectorAll('.tab-content').forEach(el => {
			el.classList.add('hidden');
		});

		// Show selected content
		document.getElementById('content-' + tabName).classList.remove('hidden');

		// Reset all buttons
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.classList.remove('border-teal-500', 'text-teal-600');
			btn.classList.add('border-transparent', 'text-slate-500');
		});

		// Highlight active button
		const activeBtn = document.getElementById('tab-' + tabName);
		activeBtn.classList.remove('border-transparent', 'text-slate-500');
		activeBtn.classList.add('border-teal-500', 'text-teal-600');
	}

	// Tools for AI Scribe
	function copyToClipboard() {
		const text = document.getElementById('transcriptionText');
		text.select();
		document.execCommand('copy');

		// Visual feedback
		const status = document.getElementById('status');
		const originalText = status.textContent;
		status.textContent = 'Copied to clipboard!';
		setTimeout(() => { status.textContent = originalText; }, 2000);
	}

	function printSection() {
		const content = document.getElementById('transcriptionText').value;
		const printWindow = window.open('', '', 'height=600,width=800');
		printWindow.document.write('<html><head><title>Print Note</title>');
		printWindow.document.write('</head><body style="font-family: sans-serif; padding: 20px;">');
		printWindow.document.write('<h2 style="border-bottom: 1px solid #ddd; padding-bottom: 10px;">Consultation Note - {{ patient.name }}</h2>');
		printWindow.document.write('<pre style="white-space: pre-wrap; font-family: sans-serif;">' + content + '</pre>');
		printWindow.document.write('</body></html>');
		printWindow.document.close();
		printWindow.print();
	}

	function shareVia(method) {
		const text = encodeURIComponent(document.getElementById('transcriptionText').value);
		if (method === 'mail') {
			window.location.href = `mailto:?subject=Consultation Note: {{ patient.name }}&body=${text}`;
		} else if (method === 'whatsapp') {
			window.open(`https://wa.me/?text=${text}`, '_blank');
		}
	}

	// Audio Upload Logic
	async function uploadAudio(input) {
		const file = input.files[0];
		if (!file) return;

		const status = document.getElementById('status');
		const textBox = document.getElementById('transcriptionText');

		status.textContent = 'Uploading & Transcribing...';

		const formData = new FormData();
		formData.append('audio', file);
		formData.append('patient_id', '{{ patient._id }}');

		try {
			const response = await fetch('/transscribe', {
				method: 'POST',
				body: formData
			});
			const result = await response.json();

			if (result.text) {
				const currentText = textBox.value;
				textBox.value = currentText ? currentText + "\n" + result.text : result.text;
				status.textContent = 'Transcription complete.';
			} else {
				status.textContent = 'Error: ' + result.error;
			}
		} catch (err) {
			status.textContent = 'Network error.';
			console.error(err);
		}

		// Reset input
		input.value = '';
	}

	// Audio Recording Logic
	const recordBtn = document.getElementById('recordBtn');
	const status = document.getElementById('status');
	const textBox = document.getElementById('transcriptionText');
	let mediaRecorder;
	let audioChunks = [];
	let isRecording = false;

	recordBtn.addEventListener('click', async (e) => {
		e.preventDefault(); // Prevent form button issues

		if (isRecording) {
			mediaRecorder.stop();
			isRecording = false;
			// Visual Updates
			recordBtn.classList.remove('animate-pulse', 'bg-red-500', 'hover:bg-red-600');
			recordBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');
			status.textContent = 'Processing audio...';
		} else {
			try {
				const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
				mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
				audioChunks = [];

				mediaRecorder.ondataavailable = event => {
					audioChunks.push(event.data);
				};

				mediaRecorder.onstop = async () => {
					const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
					const formData = new FormData();
					formData.append('audio', audioBlob);
					formData.append('patient_id', '{{ patient._id }}');

					try {
						const response = await fetch('/transscribe', {
							method: 'POST',
							body: formData
						});
						const result = await response.json();
						if (result.text) {
							const currentText = textBox.value;
							textBox.value = currentText ? currentText + "\n" + result.text : result.text;
							status.textContent = 'Transcription complete.';
						} else {
							status.textContent = 'Error: ' + result.error;
						}
					} catch (err) {
						status.textContent = 'Network error.';
						console.error(err);
					}
				};

				mediaRecorder.start();
				isRecording = true;

				// Visual Updates
				recordBtn.classList.remove('bg-teal-500', 'hover:bg-teal-600');
				recordBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
				status.textContent = 'Recording in progress...';

			} catch (err) {
				alert('Microphone access denied or not available.');
				console.error(err);
			}
		}
	});

	// Enter key configuration for textarea (optional, default behavior usually fine)

	// Check for tab parameter on load
	window.addEventListener('DOMContentLoaded', (event) => {
		const urlParams = new URLSearchParams(window.location.search);
		const tab = urlParams.get('tab');
		if (tab) {
			switchTab(tab);
		}
	});
</script>
{% endblock %}