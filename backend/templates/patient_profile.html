<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Patient Profile</title>
	<style>
		body {
			font-family: sans-serif;
			background: #f4f6f8;
			margin: 0;
			padding-bottom: 50px;
		}

		.header {
			background: white;
			padding: 1rem 2rem;
			border-bottom: 1px solid #ddd;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			margin: 0;
		}

		.back-link {
			color: #666;
			text-decoration: none;
		}

		.container {
			max-width: 1200px;
			margin: 2rem auto;
			display: grid;
			grid-template-columns: 1fr 2fr;
			gap: 2rem;
			padding: 0 1rem;
		}

		.card {
			background: white;
			padding: 1.5rem;
			border-radius: 8px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			margin-bottom: 2rem;
		}

		.section-title {
			margin-top: 0;
			border-bottom: 2px solid #007bff;
			padding-bottom: 10px;
			display: inline-block;
			margin-bottom: 15px;
		}

		.info-row {
			margin-bottom: 10px;
		}

		.info-label {
			font-weight: bold;
			color: #555;
		}

		.consultation-item {
			border-left: 3px solid #007bff;
			padding-left: 15px;
			margin-bottom: 20px;
		}

		.consultation-meta {
			font-size: 0.85em;
			color: #777;
			margin-bottom: 5px;
		}

		.consultation-text {
			white-space: pre-wrap;
		}

		.gallery-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			gap: 10px;
		}

		.file-item {
			border: 1px solid #eee;
			padding: 5px;
			text-align: center;
			border-radius: 4px;
		}

		.file-item img {
			max-width: 100%;
			height: auto;
			display: block;
			margin-bottom: 5px;
		}

		.file-link {
			font-size: 0.8em;
			text-decoration: none;
			color: #007bff;
			display: block;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.btn {
			padding: 8px 12px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		textarea {
			width: 100%;
			border: 1px solid #ddd;
			padding: 8px;
			border-radius: 4px;
			margin-bottom: 10px;
		}

		input[type="file"] {
			margin-bottom: 10px;
		}
	</style>
</head>

<body>
	<div class="header">
		<div>
			<a href="{{ url_for('patient_list') }}" class="back-link">&larr; Back to Dashboard</a>
		</div>
		<h1>{{ patient.name }}</h1>
	</div>

	<div class="container">
		<!-- Sidebar: Info & Files -->
		<div class="sidebar">
			<div class="card">
				<h3 class="section-title">Personal Info</h3>
				<div class="info-row"><span class="info-label">Age:</span> {{ patient.age }}</div>
				<div class="info-row"><span class="info-label">Address:</span> {{ patient.address }}</div>
				<div class="info-row"><span class="info-label">History:</span> {{ patient.medical_history }}</div>
				<div class="info-row"><span class="info-label">Prescription:</span> {{ patient.prescription }}</div>
			</div>

			<div class="card">
				<h3 class="section-title">Documents & X-Rays</h3>
				<form action="{{ url_for('upload_file_route', pid=patient._id) }}" method="POST"
					enctype="multipart/form-data">
					<input type="file" name="file" required>
					<button type="submit" class="btn">Upload</button>
				</form>
				<hr>
				<div class="gallery-grid">
					{% if patient.files %}
					{% for file in patient.files %}
					<div class="file-item">
						<!-- Simple check for images, otherwise specific icon logic needed -->
						{% if file.filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
						<img src="{{ file.url }}" alt="Preview">
						{% else %}
						<div
							style="height: 50px; background: #eee; display: flex; align-items: center; justify-content: center;">
							FILE</div>
						{% endif %}
						<a href="{{ file.url }}" target="_blank" class="file-link">{{ file.original_name }}</a>
					</div>
					{% endfor %}
					{% else %}
					<p style="color: #999; font-size: 0.9em;">No files uploaded.</p>
					{% endif %}
				</div>
			</div>

			<div class="card">
				<h3 class="section-title">Recorder</h3>
				<button id="recordBtn" class="btn" style="background: #dc3545;">Start Recording</button>
				<div id="status" style="margin-top: 10px; font-size: 0.9em;"></div>
			</div>
		</div>

		<!-- Main: Consultations -->
		<div class="main-content">
			<div class="card">
				<h3 class="section-title">New Consultation Note</h3>
				<form action="{{ url_for('add_consultation', pid=patient._id) }}" method="POST" id="consultForm">
					<textarea name="notes" rows="4" placeholder="Enter notes here or use recorder..."
						id="transcriptionText"></textarea>
					<button type="submit" class="btn">Add Note</button>
				</form>
			</div>

			<div class="card">
				<h3 class="section-title">Consultation History</h3>
				{% if patient.consultations %}
				{% for item in patient.consultations|reverse %}
				<div class="consultation-item">
					<div class="consultation-meta">
						{{ item.date }} | By: {{ item.doctor or 'System' }} | Type: {{ item.type|default('Manual') }}
					</div>
					<div class="consultation-text">{{ item.text }}</div>
				</div>
				{% endfor %}
				{% else %}
				<p>No consultations recorded.</p>
				{% endif %}
			</div>
		</div>
	</div>

	<script>
		// Simple Audio Recording Logic integrated for the 'transcribe' endpoint
		const recordBtn = document.getElementById('recordBtn');
		const status = document.getElementById('status');
		const textBox = document.getElementById('transcriptionText');
		let mediaRecorder;
		let audioChunks = [];

		recordBtn.addEventListener('click', async () => {
			if (mediaRecorder && mediaRecorder.state === 'recording') {
				mediaRecorder.stop();
				recordBtn.textContent = 'Start Recording';
				recordBtn.style.background = '#dc3545';
				status.textContent = 'Processing...';
			} else {
				try {
					const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
					mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
					audioChunks = [];

					mediaRecorder.ondataavailable = event => {
						audioChunks.push(event.data);
					};

					mediaRecorder.onstop = async () => {
						const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
						const formData = new FormData();
						formData.append('audio', audioBlob);
						formData.append('patient_id', '{{ patient._id }}'); // Optional: associate directly or just get text

						try {
							const response = await fetch('/transscribe', {
								method: 'POST',
								body: formData
							});
							const result = await response.json();
							if (result.text) {
								// Append to text box instead of auto-submitting, allowing doctor to review
								const currentText = textBox.value;
								textBox.value = currentText ? currentText + "\n" + result.text : result.text;
								status.textContent = 'Transcribed!';
							} else {
								status.textContent = 'Error: ' + result.error;
							}
						} catch (err) {
							status.textContent = 'Error sending audio.';
							console.error(err);
						}
					};

					mediaRecorder.start();
					recordBtn.textContent = 'Stop Recording';
					recordBtn.style.background = '#28a745';
					status.textContent = 'Recording...';
				} catch (err) {
					alert('Microphone access required');
				}
			}
		});
	</script>
</body>

</html>